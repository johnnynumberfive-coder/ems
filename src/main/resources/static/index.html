<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Directory</title>
    <style>
        body {
            font-family: Segoe UI, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: url('/images/background.jpg') no-repeat center center fixed;
            background-size: cover;
        }
        .container {
            max-width: 1100px;
            margin: 40px auto;
            background: rgba(255, 255, 255, 0.93);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
        }
        h1 { text-align: center; color: #2c3e50; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #3498db; color: white; }
        tr:hover { background: #f1f8ff; }
        .logout { float: right; margin-bottom: 15px; }
        .logout a { color: #e74c3c; text-decoration: none; font-weight: bold; font-size: 1.1em; }

        /* Modal styles */
        .modal {
            display: none; /* hidden by default */
            position: fixed;
            top: 50%!important;
            left: 50%!important;
            transform: translate(-50%, -50%)!important;
            width: 400px!important; /* or whatever width fits your form */
            max-width: 90%!important;
            z-index: 1050!important; /* above other elements */
            background: white;
            padding: 20px!important;
            border-radius: 8px!important;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3)!important;
        }

        .modal input { width: 100%!important; padding: 8px!important; margin-bottom: 10px!important; }
        .modal button { margin-right: 4px!important; }
    </style>
    <link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="logout"><a href="/logout">Logout</a></div>
    <h1>Employee Directory</h1>

    <!-- Add Employee Button -->
    <button type="button" id="addEmployeeBtn"  class="btn btn-success">Add Employee</button>
    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal">
        <h2>Add Employee</h2>
        <form id="addEmployeeForm">
            <input type="text" name="firstName" placeholder="First Name" required>
            <input type="text" name="lastName" placeholder="Last Name" required>
            <input type="email" name="email" placeholder="Email" required>
            Profile Picture: <input type="file" name="profilePic" id="profilePic">
            <button class="btn btn-primary" type="submit">Add</button>
            <button type="button" class="btn btn-danger" id="cancelAdd">Cancel</button>
        </form>
    </div>

    <!-- Update Employee Modal -->
    <div id="updateEmployeeModal" class="modal">
        <h2>Update Employee</h2>
        <form id="updateEmployeeForm">
            <input type="hidden" name="id" id="updateId">
            <input type="text" name="firstName" id="updateFirst" placeholder="First Name" required>
            <input type="text" name="lastName" id="updateLast" placeholder="Last Name" required>
            <input type="email" name="email" id="updateEmail" placeholder="Email" required>
            Profie Pic: <input type="file" name="profilePic" id="profilePic">
            <button class="btn btn-warning type="submit">Update</button>
            <button class="btn btn-danger" type="button" id="cancelUpdate">Cancel</button>
        </form>
    </div>

    <table>
        <thead>
        <tr>
            <th>Profile Pic</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="employeesTableBody"></tbody>
    </table>
</div>

<script>
    let currentUserRoles = [];

    // Get current user roles and hide Add button if not MANAGER/ADMIN
    fetch('/current-user', { credentials: 'include' })
        .then(res => res.json())
        .then(user => {
            currentUserRoles = user.roles;
            const addBtn = document.getElementById('addEmployeeBtn');
            if (!currentUserRoles.includes('ROLE_MANAGER') && !currentUserRoles.includes('ROLE_ADMIN')) {
                addBtn.style.display = 'none';
            }
        });

    // Populate employee table
    function loadEmployees() {
        fetch('/employees', { credentials: 'include' })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = "/login.html";
                    }
                    throw new Error("HTTP " + response.status);
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.getElementById('employeesTableBody');
                tbody.innerHTML = '';
                const employees = data._embedded?.employees || [];
                if (employees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="color:red;">No employees found</td></tr>';
                    return;
                }
                employees.forEach(e => {
                    const id = e._links.self.href.split('/').pop();

                    // Profile picture or default
                    const picSrc = e.profilePic
                        ? `data:image/png;base64,${e.profilePic}`
                        : '/images/default-profile.png';

                    let row = `<tr>
                    <td><img src="${picSrc}" alt="Profile Pic" style="width:50px;height:50px;border-radius:50%;"></td>
                    <td>${e.firstName}</td>
                    <td>${e.lastName}</td>
                    <td>${e.email}</td>
                    <td>`;

                    if (currentUserRoles.includes('ROLE_MANAGER') || currentUserRoles.includes('ROLE_ADMIN')) {
                        row += `<button class="updateBtn" data-id="${id}" data-first="${e.firstName}" data-last="${e.lastName}" data-email="${e.email}">Update</button>`;
                    }

                    if (currentUserRoles.includes('ROLE_ADMIN')) {
                        row += `<button class="deleteBtn" data-id="${id}">Delete</button>`;
                    }

                    row += `</td></tr>`;
                    tbody.innerHTML += row;
                });
            })
            .catch(err => {
                document.getElementById('employeesTableBody').innerHTML =
                    '<tr><td colspan="5" style="color:red;">Failed to load employees â€“ you may not be logged in</td></tr>';
                console.error(err);
            });
    }

    loadEmployees();

    // Add Employee Modal
    document.getElementById('addEmployeeBtn').addEventListener('click', () => {
        document.getElementById('addEmployeeModal').style.display = 'block';
    });
    document.getElementById('cancelAdd').addEventListener('click', () => {
        document.getElementById('addEmployeeModal').style.display = 'none';
    });

    // Add Employee Form
    document.getElementById('addEmployeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('/employees/add', {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to add employee: " + res.status);
                return res.json();
            })
            .then(data => {
                alert('Employee added!');
                document.getElementById('addEmployeeModal').style.display = 'none';
                this.reset();
                loadEmployees();
            })
            .catch(err => {
                console.error(err);
                alert('Error adding employee.');
            });
    });

    // Update Employee Modal
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('updateBtn')) {
            const btn = e.target;
            document.getElementById('updateId').value = btn.dataset.id;
            document.getElementById('updateFirst').value = btn.dataset.first;
            document.getElementById('updateLast').value = btn.dataset.last;
            document.getElementById('updateEmail').value = btn.dataset.email;
            document.getElementById('updateEmployeeModal').style.display = 'block';
        }
    });
    document.getElementById('cancelUpdate').addEventListener('click', () => {
        document.getElementById('updateEmployeeModal').style.display = 'none';
    });
    document.getElementById('updateEmployeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('updateId').value;
        const employee = {
            firstName: document.getElementById('updateFirst').value,
            lastName: document.getElementById('updateLast').value,
            email: document.getElementById('updateEmail').value
        };
        fetch(`/employees/${id}`, {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(employee)
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to update employee: " + res.status);
                return res.json();
            })
            .then(data => {
                alert('Employee updated!');
                document.getElementById('updateEmployeeModal').style.display = 'none';
                loadEmployees();
            })
            .catch(err => {
                console.error(err);
                alert('Error updating employee.');
            });
    });

    // Delete Employee
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('deleteBtn')) {
            const id = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this employee?')) {
                fetch(`/employees/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to delete employee: " + res.status);
                        alert('Employee deleted!');
                        loadEmployees();
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Error deleting employee.');
                    });
            }
        }
    });
</script>

</body>
</html>
